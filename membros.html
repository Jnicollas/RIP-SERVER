<body>
    <style>
        .pro-badge {
            display: inline-block;
            font-weight: bold;
            padding: 6px 14px;
            border-radius: 20px;
            margin-top: 14px;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: 1px;
            font-size: 14px;
        }

        .anima-1 {
            background: #ffc107;
            color: black;
            animation: blink 1s infinite;
        }

        .games-list {
            background-color: rgba(0, 133, 121, 0.25);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 1px 1px 2px #000;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .anima-2 {
            background: linear-gradient(90deg, #ffa500, #ffdd00);
            box-shadow: 0 0 10px #ffdd00aa;
            animation: pulseGlow 1.5s infinite ease-in-out;
        }

        @keyframes pulseGlow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 10px #ffdd00aa, 0 0 20px #ffa500aa;
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px #ffdd00, 0 0 30px #ffa500;
            }
        }

        .anima-3 {
            background: #ff8800;
            animation: fadeGlow 1.2s infinite ease-in-out;
        }

        @keyframes fadeGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; transform: scale(1.05); }
        }




.player-name {
    background-color: rgba(0, 0, 0, 0.6); /* Fundo escuro */
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 20px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 3px black;
    display: inline-block;
}

    </style>

    <div id="players-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;"></div>

<script>
let pendingEaIds = [];
let intervalStarted = false;

function byId(id){ return document.getElementById(id); }

async function fetchJson(url, opts = {}){
  try{
    const res = await fetch(url, { ...opts });
    const txt = await res.text();
    try { return JSON.parse(txt); }
    catch(e){ console.error("JSON inv√°lido em", url, txt); return null; }
  }catch(err){
    console.error("Falha de rede em", url, err);
    return null;
  }
}

/* 1) Busca EAIDs + userIds (suporta varia√ß√µes) */
async function fetchEaIds(){
  const url = "https://rip-bf5.com.br/login/account/members/";
  const data = await fetchJson(url, { credentials: "include" });

  if(!data || data.success === false){
    console.warn("‚ö†Ô∏è /login/account/members/ sem sucesso:", data);
    return [];
  }

  const ea_ids  = data.ea_ids || data.eaid || data.EAIDs || [];
  const userIds = data.userId || data.userIds || data.user_id || [];

  if(!Array.isArray(ea_ids) || ea_ids.length === 0){
    console.warn("‚ö†Ô∏è Nenhum EAID recebido.");
    return [];
  }

  // mapeia com seguran√ßa (userId pode estar faltando)
  return ea_ids.map((ea_id, i) => ({
    ea_id,
    user_id: Array.isArray(userIds) ? (userIds[i] ?? null) : (userIds || null)
  }));
}

/* 2) Converte EAID ‚Üí userId (fallback) */
async function resolveUserIdFromEAID(eaId){
  const url = `https://rip-bf5.com.br/api/eaid/?EAID=${encodeURIComponent(eaId)}`;
  const data = await fetchJson(url, { credentials: "include" });
  // Ajuste conforme retorno real da sua API:
  // Ex.: { success:true, player_id:"1016126611454" }
  const pid = data?.player_id || data?.userId || data?.id || null;
  if(!pid) console.warn("‚ö†Ô∏è Sem player_id no /api/eaid/ para", eaId, data);
  return pid;
}

/* 3) Fallback GameTools para nome/avatar (se player-global falhar) */
async function fetchFromGameToolsByPlayerId(userId){
  const url = `https://api.gametools.network/bfglobal/games/?playerid=${encodeURIComponent(userId)}`;
  const data = await fetchJson(url);
  if(!data) return null;
  // Tenta achar nome/avatar em poss√≠veis campos
  const userName = data.userName || data.username || data.name;
  const avatar   = data.avatar || data.avatarUrl || data.image;
  return (userName || avatar) ? { userName, avatar, games: [] } : null;
}

/* 4) Busca detalhes do jogador (usa userId; se faltar, tenta resolver por EAID) */
async function fetchPlayerDetails(eaId, userId){
  try{
    let uid = userId;
    if(!uid){
      uid = await resolveUserIdFromEAID(eaId);
      if(!uid) return null;
    }

    const url = `https://rip-bf5.com.br/api/player-global/get-user/?userId=${encodeURIComponent(uid)}&GetGames=true&GetGames-tags=true`;
    const data = await fetchJson(url, { method: "GET", credentials: "include" });

    if (data?.error || !Array.isArray(data?.users) || data.users.length === 0) {
      console.warn("‚ö†Ô∏è player-global falhou, tentando GameTools para", uid);
      const gt = await fetchFromGameToolsByPlayerId(uid);
      return gt ? gt : null;
    }

    const player = data.users[0] || {};
    return {
      userName: player.displayName || player.nickname || player.uniqueName || player.name,
      avatar: player.avatarUrl || player.avatar || null,
      games: Array.isArray(player.games) ? player.games.map(g => g?.name || g?.title || g).filter(Boolean) : []
    };

  }catch(err){
    console.error(`‚ùå Erro ao buscar jogador uid=${userId} ea=${eaId}:`, err);
    return null;
  }
}

/* 5) Permiss√µes/Config */
async function fetchPermissions(eaId){
  const data = await fetchJson(`https://rip-bf5.com.br/api/get-permissions/?ea_id=${encodeURIComponent(eaId)}`);
  return {
    permissions: Array.isArray(data?.permissions) ? data.permissions : [],
    config: data?.config || {}
  };
}

/* 6) Placeholder inicial */
function displayPlayerPlaceholder(eaId){
  const container = byId('players-container');
  const card = document.createElement('div');
  card.id = `player-${eaId}`;
  card.style.cssText = "background: rgba(0,0,0,0.5); border-radius: 10px; padding: 10px; color: white; width: 300px; text-align: center; min-height: 180px; display:flex; flex-direction:column; align-items:center; justify-content:center;";
  card.innerHTML = `<h2>Carregando...</h2>`;
  container.appendChild(card);
  if(!pendingEaIds.includes(eaId)) pendingEaIds.push(eaId);
}

/* 7) Render final do card (limpa antes de montar pra evitar duplicatas) */
async function updatePlayerDetails(eaId, data){
  const card = byId(`player-${eaId}`);
  if(!card) return;

  // limpa tudo
  card.innerHTML = "";

  const h2 = document.createElement('h2');
  h2.innerHTML = `<span class="player-name">${data.userName || `ID: ${eaId}`}</span>`;
  card.appendChild(h2);

  const avatarUrl = data.avatar || 'https://via.placeholder.com/100';
  const img = document.createElement('img');
  img.src = avatarUrl;
  img.alt = `Avatar de ${data.userName || 'Jogador'}`;
  img.style.cssText = "border-radius: 50%; width: 100px; height: 100px; margin-top: 10px;";
  card.appendChild(img);

  const gamesList = (Array.isArray(data.games) ? data.games : []).join(", ");
  const pGames = document.createElement('p');
  pGames.textContent = `Jogos: ${gamesList || "Nenhum"}`;
  pGames.className = "games-list";
  pGames.style.margin = "10px 0 0";
  card.appendChild(pGames);

  // badge + background (se tiver permiss√£o)
  const { permissions, config } = await fetchPermissions(eaId);
  if (permissions[3] === 1) {
    const anima = Number(config.anima) || 1;
    const proBadge = document.createElement('div');
    proBadge.className = `pro-badge anima-${anima}`;
    proBadge.textContent = 'üî• PRO';
    card.appendChild(proBadge);

    // aplica bg se for imagem conhecida
    const bg = (config.background || "").trim();
    if (/\.(png|jpg|jpeg|gif|webp)$/i.test(bg)) {
      const bgUrl = `https://choriper.api-rip-bf5.org/upload/upload/view/${bg}`;
      card.style.backgroundImage = `url('${bgUrl}')`;
      card.style.backgroundSize = 'cover';
      card.style.backgroundPosition = 'center';
    }
  }

  // remove da fila pendente
  pendingEaIds = pendingEaIds.filter(id => id !== eaId);
}

/* 8) Fluxo principal */
async function loadPlayers(){
  const players = await fetchEaIds();
  const container = byId('players-container');

  // sem players ‚Üí mostra aviso
  if(!players || players.length === 0){
    container.innerHTML = `<div style="color:#fff; font-weight:bold;">Nenhum jogador encontrado. Verifique se est√° logado e se /login/account/members/ est√° retornando dados.</div>`;
    return;
  }

  const successEaIds = [];
  const failedEaIds = [];

  // placeholders
  for (const { ea_id } of players) displayPlayerPlaceholder(ea_id);

  // resolve todos em paralelo
  await Promise.all(players.map(async ({ ea_id, user_id }) => {
    const data = await fetchPlayerDetails(ea_id, user_id);
    if (data && (data.userName || data.avatar)) {
      await updatePlayerDetails(ea_id, data);
      successEaIds.push(ea_id);
    } else {
      failedEaIds.push(ea_id);
    }
  }));

  // manda os falhados para o fim (visualmente)
  for (const id of failedEaIds) {
    const div = byId(`player-${id}`);
    if (div) container.appendChild(div);
  }

  console.log(`‚úÖ Sucesso: ${successEaIds.length} | ‚ùå Falha: ${failedEaIds.length}`);

  // inicia o retry uma √∫nica vez
  if(!intervalStarted){
    intervalStarted = true;
    setInterval(retryPendingPlayers, 16000);
  }
}

/* 9) Recarrega s√≥ os pendentes */
async function retryPendingPlayers(){
  if (pendingEaIds.length === 0) return;
  console.log(`üîÅ Tentando recarregar ${pendingEaIds.length} jogadores...`);

  const mapping = await fetchEaIds();
  for (const eaId of [...pendingEaIds]) {
    const pair = mapping.find(p => p.ea_id === eaId);
    if(!pair) continue;

    const data = await fetchPlayerDetails(pair.ea_id, pair.user_id);
    if (data && (data.userName || data.avatar)) {
      await updatePlayerDetails(pair.ea_id, data);
    }
  }
}

// inicia
loadPlayers();
</script>

</body>
