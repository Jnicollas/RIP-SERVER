<!-- wp:html -->
<!-- wp:html -->
<iframe 
  title="perfil"
  src="https://rip-bf5.com.br/login/perfil/"
  style="position: fixed; top: 20px; right: 20px; width: 220px; height: 120px; border: none; background: transparent; overflow: hidden;"
></iframe>

<main class="wp-block-group" style="margin-top:0">
  <!-- Fundo de imagem -->
  <div style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    overflow: hidden;
    z-index: -1;
    background: url('https://rip-bf5.com.br/wp-content/uploads/2025/05/server.jpg') center center / cover no-repeat;
  "></div>

  <audio id="sound1" preload="auto" src="https://rip-bf5.com.br/wp-content/uploads/2024/12/UI_Flag_Capturing_Stopped_Wave-0-0-0.mp3"></audio>
  <audio id="sound2" preload="auto" src="https://rip-bf5.com.br/wp-content/uploads/2024/12/UI_Flag_Capturing_Wave-0-8-0.mp3"></audio>
</main>

    <style>
.platoon-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    max-width: 180px;
    margin: 0 auto;
    text-align: center;
    word-wrap: break-word;
}

.platoon-info img {
    width: 120px;
    height: 120px;
    object-fit: contain;
    border-radius: 50%;
    display: block;
    margin: 0 auto 6px auto; /* alinha ao centro e dá espaço embaixo */
}

.platoon-name {
    font-weight: bold;
    font-size: 14px;
    color: white;
    white-space: normal;
    word-break: break-word;
}

.platoon-description {
    font-size: 12px;
    color: white;
    opacity: 0.9;
    white-space: normal;
    word-break: break-word;
}






.server-info-container {
    display: flex;
    align-items: center;
    border-bottom: 2px solid rgba(255, 255, 255, 0.5);
    padding-bottom: 10px;
    flex-wrap: wrap;
}

.map-img {
    width: 200px;
    height: 120px;
    object-fit: cover;
    margin-right: 15px;
    border-radius: 5px;
}

.server-text {
    color: white;
    max-width: 60%;
}
@keyframes bounceSide {
    0%   { transform: translateX(0); }
    50%  { transform: translateX(20px); }
    100% { transform: translateX(0); }
}

.server-name {
    font-size: 26px;
    font-weight: 700;
    text-align: center;
    font-family: inherit !important;

    text-shadow:
        -1px -1px 0 #fff,
         1px -1px 0 #fff,
        -1px  1px 0 #fff,
         1px  1px 0 #fff;

    display: inline-block;
    animation: bounceSide 2s infinite ease-in-out;
}


.avatar-img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    margin-left: 50px;
}

/* RESPONSIVO: Mobile */
@media screen and (max-width: 768px) {
    .server-info-container {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .map-img {
        width: 90%;
        height: auto;
        margin: 0 0 10px 0;
    }

    .server-text {
        max-width: 90%;
    }

    .avatar-img {
        margin-left: 0;
        margin-top: 10px;
    }
}

.loading-players {
    color: white;
    text-align: center;
    font-weight: bold;
    margin-top: 15px;
}




body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: -1;
}







.team-container-all {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 20px;
    margin-top: 20px;
}

@media screen and (max-width: 768px) {
    .team-container-all {
        flex-direction: column;
        gap: 40px;
    }

    .team-wrapper img {
        display: none; /* Esconde imagem do time no mobile */
    }
}

.team-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

.team-header {
    text-align: center;
    margin-bottom: 10px;
}

.team-header h3 {
    color: white;
    font-size: 18px;
    margin: 0;
}

.player-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

@media screen and (max-width: 768px) {
    .player-table {
        font-size: 12px;
    }
}








/* Ajusta o layout da tabela para mobile */
.table-container {
    max-width: 100%;
    overflow-x: auto;
}

/* Estilo da tabela */
table {
    width: 100%;
    border-collapse: collapse;
}

/* Ajusta as células para evitar quebra */
td, th {
    padding: 5px;
    text-align: center;
    white-space: nowrap;
}

/* Melhora a responsividade */
@media screen and (max-width: 768px) {
    table {
        font-size: 12px;
    }

    th, td {
        padding: 5px;
    }

    /* Se necessário, adiciona rolagem horizontal */
    .table-container {
        overflow-x: auto;
    }
}
/* Remove espaços vazios entre elementos */
.wp-block-group {
    margin: 0;
    padding: 0;
}

/* Remove margens desnecessárias */
p:empty {
    display: none;
}



    </style>

    <!-- Campo de busca e resultados -->
    <div class="wp-block-group alignwide" style="position: relative; z-index: 1; color: white; padding: 20px;">
        <!-- Campo de busca -->
        <div style="margin-bottom: 20px;">
            <label for="server-search" style="display: block; margin-bottom: 8px;">Digite o nome do servidor:</label>
            <input id="server-search" type="text" placeholder="Exemplo: RIP" style="padding: 8px; width: 80%; max-width: 300px; border-radius: 5px; border: 1px solid white; background: rgba(0, 0, 0, 0.6); color: white;">
            
            <button onclick="searchServer()" 
            style="padding: 8px 15px; margin-right: 10px; cursor: pointer; background: rgba(255, 255, 255, 0.8); color: black; border: none; border-radius: 5px;">
            Pesquisar
        </button>
            <!-- Seletores -->
            <select id="region-select" 
                style="padding: 8px; margin-right: 10px; border-radius: 5px; border: 1px solid white; background: rgba(0, 0, 0, 0.6); color: white;">
                <option value="sam">América do Sul</option>
                <option value="nam">América do Norte</option>
                <option value="afr">África</option>
                <option value="au">Austrália</option>
                <option value="oc">Oceania</option>
                <option value="asia">Ásia</option>
                <option value="eu">Europa</option>
                <option value="all">Todas as regiões</option>
            </select>
    
            <select id="limit-select" 
                style="padding: 8px; margin-right: 10px; border-radius: 5px; border: 1px solid white; background: rgba(0, 0, 0, 0.6); color: white;">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="100">100</option>
                <option value="100">250</option>
            </select>
    
            <select id="platform-select" 
                style="padding: 8px; margin-right: 10px; border-radius: 5px; border: 1px solid white; background: rgba(0, 0, 0, 0.6); color: white;">
                <option value="pc">PC</option>
                <option value="xboxone">Xbox One</option>
                <option value="ps4">PlayStation 4</option>
            </select>

                <!-- Botões -->
            <button onclick="Core()" 
                style="padding: 8px 15px; margin-right: 10px; cursor: pointer; background: rgba(255, 255, 255, 0.8); color: black; border: none; border-radius: 5px;">
                Hardcore
            </button>
            <button onclick="DICE()" 
                style="padding: 8px 15px; margin-right: 10px; cursor: pointer; background: rgba(255, 255, 255, 0.8); color: black; border: none; border-radius: 5px;">
                DICE
            </button>
            <button onclick="TDM()" 
                style="padding: 8px 15px; margin-right: 10px; cursor: pointer; background: rgba(255, 255, 255, 0.8); color: black; border: none; border-radius: 5px;">
                TDM
            </button>
            <button onclick="RIP()" 
                style="padding: 8px 15px; margin-right: 10px; cursor: pointer; background: rgba(255, 255, 255, 0.8); color: black; border: none; border-radius: 5px;">
                RIP
            </button>
            </div>

        <!-- Exibição dos dados do servidor -->
        <div id="server-container">Carregando informações do servidor...</div>

        <script>

const defaultApiUrl = "https://api.gametools.network/bfv/servers/?platform=pc&limit=10&region=sam&lang=pt-br";

async function fetchServerData(query = "") {
    // Definir a URL base com os valores padrão
    const region = document.getElementById("region-select")?.value || "sam";
    const limit = document.getElementById("limit-select")?.value || "10";
    const platform = document.getElementById("platform-select")?.value || "pc";
    const encodedQuery = encodeURIComponent(query);
    const apiUrl = `https://api.gametools.network/bfv/servers/?platform=${platform}&limit=${limit}&region=${region}&lang=pt-br&name=${encodedQuery}`;

    try {
        // Realizar a requisição à API
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.servers && data.servers.length > 0) {
            displayServerData(data.servers);
        } else {
            document.getElementById("server-container").innerText = "Nenhum servidor encontrado.";
        }
    } catch (error) {
        console.error("Erro ao buscar dados do servidor:", error);
        document.getElementById("server-container").innerText = "Erro ao carregar informações do servidor.";
    }
}

        async function fetchAdmData() {
            try {
                const response = await fetch('https://rip-bf5.com.br/arquivos-CENTER/adm-oficial-verificado.json');
                if (!response.ok) {
                    throw new Error(`Erro ao carregar o arquivo JSON: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Erro ao buscar dados do arquivo JSON:', error);
                return null;
            }
        }

        async function getLoggedUserId() {
    try {
        const response = await fetch('https://rip-bf5.com.br/login/account/', {
            method: 'POST',
            body: new URLSearchParams({ action: 'check-login' })
        });

        const result = await response.json();
        //console.log('Resultado da verificação de login:', result); // Log do resultado

        if (result.success && result.ea_id) {
            return result.ea_id; // Retorna o EA ID do usuário logado
        }
        return null; // Retorna null caso não esteja logado ou não tenha EA ID
    } catch (error) {
        console.error('Erro ao obter o EA ID do usuário logado:', error);
        return null;
    }
}


async function displayServerData(servers) {
    const admData = await fetchAdmData();
    const loggedUserId = await getLoggedUserId();
    const container = document.getElementById("server-container");

    container.innerHTML = servers.map(server => {
        const admInfo = admData[server.ownerId] || [0, 0, 0, 0];
        const [isVerified, isOfficial, isChoriper, isOfficialBoB] = admInfo;
        const isOwnedByUser = loggedUserId && server.ownerId && loggedUserId === server.ownerId ? 1 : 0;
        const showOwnedByUserLabel = isOwnedByUser === 1 ? '<span style="color: #FF9800;">👤 Seu Servidor</span>' : '';

        return `
            <div class="server-box" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px; border-radius: 0px; background-color: rgba(0, 0, 0, 0.3); padding: 10px;">
                <div onclick="showServerDetails('${server.gameId}', '${server.ownerId}')" style="display: flex; align-items: center; cursor: pointer;">
                    <img src="${server.url || ''}" alt="Imagem do Mapa" style="width: 80px; height: 80px; object-fit: cover; margin-right: 15px; border-radius: 0px;" />
                    <div style="flex: 1; color: white;">
                        <h3 style="margin: 0; color: white; font-size: 18px;">
                            ${server.prefix || "Servidor Desconhecido"} 
                            ${isVerified ? '<span style="color: #4CAF50;">✔ Verificado</span>' : ''}
                            ${isOfficial ? '<span style="color: #2196F3;">⭐ Oficial</span>' : ''}
                            ${isChoriper ? '<span style="color: #FFC107;">🛠️ Choriper</span>' : ''}
                            ${isOfficialBoB ? '<span style="color: #FFC107;">🌎 OficialBoB</span>' : ''}
                            ${showOwnedByUserLabel}
                        </h3>
                        <p style="margin: 5px 0;"><strong>Mapa Atual:</strong> ${server.currentMap || "N/A"}</p>
                        <p style="margin: 5px 0;"><strong>Modo de Jogo:</strong> ${server.mode || "N/A"}</p>
                        <p style="margin: 5px 0;"><strong>Jogadores:</strong> ${server.playerAmount || 0} / ${server.maxPlayers || 0} Fila ${server.inQue || 0} (${server.inSpectator || 0})</p>
                        <p style="margin: 5px 0;"><strong>Região:</strong> ${server.country || "N/A"} (${server.region || "N/A"})</p>
                    </div>
                </div>
                <div style="margin-left: 20px; font-size: 18px;">
                    <button onclick="analisarServidor('${server.gameId}', this)" style="padding: 6px 12px; font-size: 14px; border-radius: 5px; cursor: pointer; background: #2196F3; color: white; border: none;">
                        🔍 Analisar
                    </button>
                </div>
            </div>
        `;
    }).join('');
}
async function getCookie(name) {
    try {
        const res = await fetch("https://rip-bf5.com.br/api/token/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });

        const data = await res.json();
        if (data.success && data.token) {
            // Salva o token sem definir tempo de expiração
            document.cookie = `api_token=${data.token}; path=/; Secure; SameSite=None`;
            return data.token;
        }
    } catch (err) {
        console.error("❌ Erro ao solicitar novo token:", err);
    }
    return null;
}

// 🔍 Chamada para análise de servidor (sempre com novo token)
async function analisarServidor(gameId, buttonElement) {
    try {
        buttonElement.innerHTML = '⏳ Carregando...';

        const token = await getCookie("api_token");
        const payload = { gameId, api_token: token };

        const response = await fetch("https://rip-bf5.com.br/api/server-database-notes/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        const quantidade = data?.resposta?.quantidade ?? 0;

        // ✅ Mostra a quantidade no botão
        buttonElement.innerHTML = `🔍 ${quantidade}`;

        // 🔴 Deixa vermelho se houver dados (banido/anotado)
        if (quantidade > 0) {
            buttonElement.style.backgroundColor = '#f44336'; // vermelho
        } else {
            buttonElement.style.backgroundColor = '#4CAF50'; // verde
        }
    } catch (err) {
        buttonElement.innerHTML = '⚠️ Erro';
        buttonElement.style.backgroundColor = '#f44336';
        console.error("Erro ao analisar servidor:", err);
    }
}






// Exemplo de chamada com lista de servidores
fetchServerData("rip"); // Insira aqui a função que busca os servidores

async function fetchAllPlayerStats(playerIds) {
    if (!playerIds || playerIds.length === 0) return [];

    try {
        const response = await fetch('https://api.bfvrobot.net/api/worker/player/getBatchAllStats', {
            method: 'POST',
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
            body: JSON.stringify({ personaIds: playerIds, detail: false })
        });

        if (!response.ok) {
            console.error('Erro ao buscar estatísticas dos jogadores:', response.statusText);
            return [];
        }

        const data = await response.json();
        return data?.data || [];
    } catch (error) {
        console.error('Erro ao buscar estatísticas dos jogadores:', error);
        return [];
    }
}

async function verificarBanimentos(playerIds) {
    if (!playerIds || playerIds.length === 0) return;

    try {
        const formData = new URLSearchParams();
        formData.append("ids", playerIds.join(","));

        // 🍪 Captura o token via função async
        const getCookie = async (nome) => {
            const match = document.cookie.match(new RegExp("(^| )" + nome + "=([^;]+)"));
            return match ? decodeURIComponent(match[2]) : null;
        };

        const token = await getCookie("api_token");
        if (token) {
            formData.append("api_token", token);
        }

        const response = await fetch("https://rip-bf5.com.br/api/manager/choriper-api/verificar_ids/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: formData.toString()
        });

        if (!response.ok) {
            console.error("❌ Erro ao verificar banimentos:", response.statusText);
            return;
        }

        const data = await response.json();

        if (data.status === "ok" && Array.isArray(data.dados)) {
            data.dados.forEach(banido => {
                const el = document.querySelector(`#player-${banido.id} td:nth-child(2)`);
                if (!el) return;

                const motivoOriginal = banido.reason?.trim() || "";
                const anotacoesOriginal = banido.notes?.trim() || "";

                // ❌ Se não tiver motivo e notas, não exibe nada (sem cor e sem tooltip)
                if (!motivoOriginal && !anotacoesOriginal) return;

                const statusBan = banido.ban === true;
                const cor = statusBan ? "red" : "orange";
                const emoji = statusBan ? "🚫 Banido" : "⚠️ Aviso";

                // ✅ Só aplica cor se houver conteúdo a exibir
                el.style.color = cor;
                el.style.fontWeight = "bold";

                const urlRegex = /(https?:\/\/[^\s]+)/g;

                const processarTextoComLinks = (texto) => {
                    return texto.replace(urlRegex, url => {
                        if (url.match(/\.(jpeg|jpg|png|webp|gif)(\?|$)/i)) {
                            return `<br><img src="${url}" style="max-width:100%;max-height:120px;border-radius:6px;margin-top:5px;">`;
                        } else {
                            return `<br><a href="${url}" target="_blank" style="display:inline-block;margin-top:4px;padding:4px 8px;background:#444;color:#fff;border-radius:4px;text-decoration:none;">🔗 Abrir link</a>`;
                        }
                    });
                };

                const motivo = processarTextoComLinks(motivoOriginal);
                const anotacoes = processarTextoComLinks(anotacoesOriginal);

                const tooltipDiv = document.createElement("div");
                tooltipDiv.className = "custom-tooltip";
                tooltipDiv.innerHTML = `
                    <strong>${emoji}</strong><br>
                    <strong>Ban:</strong> ${statusBan ? "Sim" : "Não"}<br>
                    <strong>Ban Global:</strong> ${banido.ban_global === true ? "Sim" : "Não"}<br>
                    <strong>Aplicado por:</strong> ${banido.by || "Desconhecido"}<br>
                    <strong>Motivo:</strong> ${motivo}<br>
                    <strong>Notas:</strong> ${anotacoes}<br>
                    <strong>Data:</strong> ${banido.timestamp ? new Date(banido.timestamp).toLocaleString() : "Desconhecida"}
                `;

                Object.assign(tooltipDiv.style, {
                    position: "absolute",
                    zIndex: "9999",
                    background: "#222",
                    color: "#fff",
                    padding: "8px",
                    borderRadius: "6px",
                    boxShadow: "0 0 8px rgba(0,0,0,0.5)",
                    fontSize: "13px",
                    maxWidth: "300px",
                    maxHeight: "350px",
                    overflow: "auto",
                    display: "none",
                    whiteSpace: "normal"
                });

                document.body.appendChild(tooltipDiv);

                let hideTimeout;

                const showTooltip = () => {
                    clearTimeout(hideTimeout);
                    tooltipDiv.style.display = "block";
                    const rect = el.getBoundingClientRect();
                    tooltipDiv.style.top = `${rect.top + window.scrollY - tooltipDiv.offsetHeight - 10}px`;
                    tooltipDiv.style.left = `${rect.left + window.scrollX}px`;
                };

                const hideTooltip = () => {
                    hideTimeout = setTimeout(() => {
                        tooltipDiv.style.display = "none";
                    }, 200);
                };

                el.addEventListener("mouseenter", showTooltip);
                el.addEventListener("mouseleave", hideTooltip);
                tooltipDiv.addEventListener("mouseenter", () => clearTimeout(hideTimeout));
                tooltipDiv.addEventListener("mouseleave", hideTooltip);
            });
        }
    } catch (error) {
        console.error("❌ Erro ao buscar dados de banimento:", error);
    }
}






let isFetchingServerDetails = false;

async function showServerDetails(gameId, ownerId) {
    if (isFetchingServerDetails) return;
    isFetchingServerDetails = true;

    const container = document.getElementById("server-container");
    container.innerHTML = `<p style="color: white; text-align: center;">Carregando servidor...</p>`;

    if (!gameId || ["null", "undefined"].includes(gameId)) {
        console.error("Erro: gameId inválido:", gameId);
        container.innerHTML = `<p style="color: red; text-align: center;">Erro: gameId inválido.</p>`;
        isFetchingServerDetails = false;
        return;
    }

    const apiUrl = `https://api.gametools.network/bfv/detailedserver/?gameid=${encodeURIComponent(gameId)}&lang=pt-br&region=all&platform=pc`;
    const playersApiUrl = `https://api.gametools.network/bfv/players/?gameId=${gameId}`;

    try {
        const fetches = [fetch(apiUrl).then(res => res.ok ? res.json() : Promise.reject(new Error(`Erro API servidor: ${res.status}`)))];

        if (ownerId && !["undefined", "null"].includes(ownerId)) {
            fetches.push(fetchOwnerAvatar(ownerId));
        } else {
            fetches.push(Promise.resolve(null));
        }

        const [serverResponse, avatarUrl] = await Promise.all(fetches);
        console.log("✅ serverResponse:", serverResponse);

        if (!serverResponse?.teams || !serverResponse?.rotation) {
            throw new Error("Detalhes incompletos do servidor.");
        }

        displayBasicServerData(serverResponse, null); // mostra os dados do servidor logo

        // 🔄 carrega a parte do pelotão em segundo plano
        if (ownerId && !["undefined", "null"].includes(ownerId)) {
            setTimeout(() => {
                fetchOwnerAvatar(ownerId).then(data => {
                    if (data) {
                        // Remove o placeholder antigo
                        const loadingDiv = document.getElementById("platoon-loading");
                        if (loadingDiv) loadingDiv.remove();

                        const platoonHTML = `
                            <div class="platoon-info">
                                <img class="avatar-img" src="${data.emblem}" alt="Emblema do Pelotão">
                                <div class="platoon-name">${data.name}</div>
                                <div class="platoon-description">${data.description}</div>
                            </div>`;
                        document.querySelector(".server-info-container").insertAdjacentHTML("beforeend", platoonHTML);
                    }
                });
            }, 300);// espera 300ms
        }


        // 🔁 Tenta buscar jogadores até 3 vezes se não retornar dados válidos
        // 🔁 Tenta buscar jogadores até 4 vezes, com timeout extra
        let playersData;
        let attempts = 0;
        while (attempts < 4) {
            try {
                const response = await fetch(playersApiUrl, { cache: "no-store" });
                if (!response.ok) throw new Error(`Erro na tentativa ${attempts + 1}: ${response.status}`);
                playersData = await response.json();

                if (playersData?.teams?.length > 0) break;
            } catch (err) {
                console.warn(`Tentativa ${attempts + 1} falhou:`, err);
            }

            await new Promise(resolve => setTimeout(resolve, 2500)); // espera maior
            attempts++;
        }

        if (!playersData?.teams || playersData.teams.length === 0) {
            throw new Error("⚠️ Dados de jogadores não foram carregados após várias tentativas.");
        }


        if (!playersData?.teams || playersData.teams.length === 0) {
            throw new Error("Dados de jogadores incompletos após múltiplas tentativas.");
        }

        updatePlayersData(playersData.teams, serverResponse);

    } catch (error) {
        console.error("Erro ao carregar detalhes do servidor:", error);
        container.innerHTML = `<p style="color: red; text-align: center;">${error.message}</p>`;
    } finally {
        isFetchingServerDetails = false;
    }
}


async function fetchOwnerAvatar(ownerId) {
    try {
        const response = await fetch(`https://api.gametools.network/bfv/all/?format_values=false&lang=pt-br&platform=pc&playerid=${ownerId}`);
        if (!response.ok) throw new Error("Erro ao carregar dados do jogador");

        const data = await response.json();
        if (!data.activePlatoon) return null;

        return {
            emblem: data.activePlatoon.emblem || null,
            name: data.activePlatoon.name || "Pelotão Desconhecido",
            description: data.activePlatoon.description || ""
        };
    } catch (error) {
        console.error("Erro na função fetchOwnerAvatar:", error);
        return null;
    }
}


async function displayBasicServerData(server, avatarUrl) {
    const container = document.getElementById("server-container");

    const descriptionApiUrl = server.owner && server.owner.id
        ? `https://rip-bf5.com.br/api/server/descriptionServer/?personaId=${server.owner.id}&playgroundId=${encodeURIComponent(server.playgroundId)}`
        : null;

    const fetchDescription = async () => {
        if (!descriptionApiUrl) return null;
        try {
            const response = await fetch(descriptionApiUrl);
            if (response.ok) {
                const data = await response.json();
                return data.server || null;
            }
        } catch (error) {
            console.error("Erro ao buscar a descrição do servidor:", error);
        }
        return null;
    };

    const descriptionPromise = fetchDescription();

    container.innerHTML = `
    
<div class="server-info-container">
    <img class="map-img" src="${server.currentMapImage}" alt="Mapa Atual">
    <div class="server-text">
        <h3 class="server-name">${server.prefix}</h3>
        <p><strong>Modo:</strong> ${server.mode}</p>
        <p><strong>Mapa:</strong> ${server.currentMap}</p>
        <p><strong>Jogadores:</strong> ${server.playerAmount}/${server.maxPlayerAmount} - Fila: ${server.inQueue}</p>
        <p><strong>Região:</strong> ${server.region} (${server.country})</p>
        <p id="server-description" style="display: none;"><strong>Descrição:</strong> Carregando...</p>
        <p id="modo-dano" style="display: none;"><strong>Dano:</strong> Carregando...</p>
        <p id="tk" style="display: none;"><strong>Fogo amigo:</strong> Carregando...</p>
    </div>
${avatarUrl ? `
    <div class="platoon-info">
        <img class="avatar-img" src="${avatarUrl.emblem}" alt="Emblema do Pelotão">
        <div class="platoon-name">${avatarUrl.name}</div>
        <div class="platoon-description">${avatarUrl.description}</div>
    </div>
` : `
    <div class="platoon-info" id="platoon-loading">
        <div style="color: white; font-size: 12px;">⏳ Carregando pelotão...</div>
    </div>
`}

</div>

</div>

<div>
    <h4 style="color: white; cursor: pointer;" onclick="toggleMapRotation()" id="mapRotationHeader">Clica aqui pra ver a Rotação de Mapas:</h4>
    <div id="mapRotation" style="display: none; padding-top: 10px;">
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            ${server.rotation.map(map => `
                <div style="flex: 1 1 calc(9% - 20px); margin-bottom: 10px;">
                    <img src="${map.image}" alt="${map.mapname}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 5px;">
                    <p style="color: white; text-align: center;">${map.mapname} - ${map.mode}</p>
                </div>
            `).join('')}
        </div>
    </div>
</div>

<h4 
    onclick="togglePlayerMapVisibility()" 
    id="playerMapHeader"
    style="
        color: #00ffcc;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        margin: 20px 0 10px;
        text-shadow: 0 0 4px rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        gap: 8px;
    "
>
    🌍 Clica aqui pra ver o Mapa de Distribuição de Jogadores:
</h4>

<div id="playerMapContainer" style="display: none; margin: 10px auto; width: 100%; max-width: 1200px; border-radius: 12px; overflow: hidden; box-shadow: 0 0 12px rgba(0, 255, 204, 0.2);">
    <iframe 
        id="playerMapIframe" 
        src="about:blank"
        style="
            width: 100%; 
            height: 550px; 
            border: none; 
            background-color: rgba(0,0,0,0.25); 
            backdrop-filter: blur(4px);
        "
        allowfullscreen
    ></iframe>
</div>

<p id="next-update" style="
  color: #00ffcc;
  text-align: center;
  font-size: 14px;
  margin-top: 8px;
">
🔄 Atualizando em 16s...
</p>


    <div class="team-container-all">
        <div id="div0"></div>
        <div id="div1"></div>
    </div>

    <p id="loading-players" style="color: white; text-align: center; font-weight: bold; margin-top: 15px;">🔄 Carregando lista de jogadores...</p>

    `;
    if (server.gameId) {
    const iframe = document.getElementById("playerMapIframe");
    iframe.src = `https://rip-bf5.com.br/api/server/map/?gameId=${server.gameId}`;
}


    // Aplicar dados da API
    descriptionPromise.then(serverData => {
        if (serverData) {
            const desc = document.getElementById("server-description");
            const dano = document.getElementById("modo-dano");
            const tk = document.getElementById("tk");

            if (serverData.description) {
                desc.innerHTML = `<strong>Descrição:</strong> ${serverData.description}`;
                desc.style.display = "block";
            }

            if (serverData.modo_dano) {
                dano.innerHTML = `<strong>Dano:</strong> ${serverData.modo_dano}`;
                dano.style.display = "block";
            }

            if (serverData.tk !== undefined) {
                const value = serverData.tk === "true" ? "Sim 🔥" : "Não";
                tk.innerHTML = `<strong>Fogo amigo:</strong> ${value}`;
                tk.style.display = "block";
            }
        }
    });
}



let isFetchingPlayerStats = false; // Flag para impedir requisições repetidas

async function updatePlayersData(teams, server, retry = 0) {
    console.log("⏳ updatePlayersData chamada", { teams, server, retry });

    if (isFetchingPlayerStats) return;
    isFetchingPlayerStats = true;

    const cacheKey = `playersData_${server.gameId}`;
    const cached = localStorage.getItem(cacheKey);
    const now = Date.now();

    // ⚡ Verifica se há cache válido (1 minuto)
    if (cached) {
        const { timestamp, data } = JSON.parse(cached);
        if (now - timestamp < 30000) {
            console.log("⚡ Usando cache de jogadores");
            renderPlayersFromTeams(data, server);
            isFetchingPlayerStats = false;
            return;
        }
    }

    // Tentativas de requisição dupla
    try {
        const playersResponse1 = await fetch(`https://api.gametools.network/bfv/players/?gameId=${server.gameId}`);
        const playersData1 = await playersResponse1.json();

        await new Promise(resolve => setTimeout(resolve, 300)); // pequeno delay

        const playersResponse2 = await fetch(`https://api.gametools.network/bfv/players/?gameId=${server.gameId}`);
        const playersData2 = await playersResponse2.json();

const finalTeams = playersData2?.teams?.length > 0 ? playersData2.teams : playersData1.teams;

// Salva no cache
localStorage.setItem(cacheKey, JSON.stringify({
    timestamp: now,
    data: finalTeams
}));

// 🔁 Atualiza para render loop
window.lastTeams = finalTeams;
window.lastServer = server;

renderPlayersFromTeams(finalTeams, server);

    } catch (err) {
        console.error("❌ Erro nas tentativas duplas de fetch com cache:", err);
        document.getElementById("server-container").innerText = "Erro ao carregar lista de jogadores.";
    } finally {
        isFetchingPlayerStats = false;
    }
}

// Função extraída para renderizar
async function renderPlayersFromTeams(teams, server) {
    const teamOne = teams[0]?.players || [];
    const teamTwo = teams[1]?.players || [];
    const token = await getCookie("api_token");

    document.getElementById("loading-players")?.remove();
    document.getElementById('div0').innerHTML = `<p style="color: white; text-align: center; font-weight: bold; margin-top: 15px;">🔄 Carregando lista de jogadores...</p>`;
    document.getElementById('div1').innerHTML = "";



    try {
        const playerIds = [...teamOne, ...teamTwo].map(p => p.player_id);
        const playerStatsArray = await fetchAllPlayerStats(playerIds);

        renderTeamPlayers(teamOne, document.getElementById('div0'), playerStatsArray, server.teams.teamOne?.name || 'Time 1', server.teams.teamOne?.image || '');
        renderTeamPlayers(teamTwo, document.getElementById('div1'), playerStatsArray, server.teams.teamTwo?.name || 'Time 2', server.teams.teamTwo?.image || '');
    } catch (error) {
        console.error("Erro ao renderizar times:", error);
    }
}




function addSortingFunctionality(teamDiv) {
    const headers = teamDiv.querySelectorAll("th");
    headers.forEach((header, index) => {
        if (index === 0 || index === 8) return; // Não adiciona evento para # e "Denunciar"

        header.style.cursor = "pointer";
        header.setAttribute("data-order", "asc"); // 🔹 Começa sempre do menor para o maior

        header.addEventListener("click", () => {
            const order = header.getAttribute("data-order");
            const newOrder = order === "asc" ? "desc" : "asc"; // 🔹 Alterna corretamente a ordem
            header.setAttribute("data-order", newOrder);

            sortTable(teamDiv, index, newOrder);
        });
    });
}

function sortTable(teamDiv, columnIndex, order) {
    const table = teamDiv.querySelector("tbody");
    const rows = Array.from(table.querySelectorAll("tr"));

    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].innerText.trim();
        let bValue = b.cells[columnIndex].innerText.trim();

        // 🔹 Remove letras e converte corretamente para número
        if (columnIndex === 2) { // Latência (Remove "ms")
            aValue = parseInt(aValue.replace("ms", "")) || 0;
            bValue = parseInt(bValue.replace("ms", "")) || 0;
        } else if (columnIndex === 6) { // Tempo de Jogo (Converte para minutos)
            aValue = convertTimeToMinutes(aValue);
            bValue = convertTimeToMinutes(bValue);
        } else {
            // Converte para número apenas se for possível
            if (!isNaN(aValue) && !isNaN(bValue)) {
                aValue = parseFloat(aValue);
                bValue = parseFloat(bValue);
            }
        }

        return order === "asc" ? aValue - bValue : bValue - aValue;
    });

    // Reanexa as linhas ordenadas na tabela
    rows.forEach(row => table.appendChild(row));
}

// 🔹 Converte "2648h 27m" para total de minutos (exemplo: 2648h 27m → 158907 minutos)
function convertTimeToMinutes(timeString) {
    const timeParts = timeString.match(/(\d+)h\s*(\d+)?m?/);
    if (!timeParts) return 0;

    const hours = parseInt(timeParts[1]) || 0;
    const minutes = parseInt(timeParts[2]) || 0;

    return (hours * 60) + minutes;
}


async function renderTeamPlayers(players, teamDiv, playerStatsArray, teamName, teamImage) {
    // Exibe cabeçalho com nome e imagem no PC
    teamDiv.innerHTML = `
        <div class="team-wrapper">
            <div class="team-header">
                <img src="${teamImage}" alt="${teamName}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; margin-bottom: 5px;">
                <h3>${teamName}</h3>
            </div>

            <div class="table-container">
                <table class="player-table">
                    <thead>
                        <tr style="background: rgba(0, 0, 0, 0.7); color: white;">
                            <th>#</th>
                            <th>Jogador</th>
                            <th>Latência</th>
                            <th>Kills</th>
                            <th>HS</th>
                            <th>K/D</th>
                            <th>Tempo de Jogo</th>
                            <th>Level</th>
                            <th>Denunciar</th>
                        </tr>
                    </thead>
                    <tbody id="player-list-${teamDiv.id}">
                        <!-- Jogadores serão inseridos aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    `;

    const playerList = document.getElementById(`player-list-${teamDiv.id}`);
    playerList.innerHTML = players.map((player, index) => {
        const rowColor = index % 2 === 0 ? "rgba(0, 0, 0, 0.5)" : "rgba(0, 0, 0, 0.3)";

        return `
            <tr id="player-${player.player_id}" style="background: ${rowColor}; color: white;">
                <td style="padding: 5px; text-align: center;">${index + 1}</td>
                <td style="padding: 5px; text-align: center; color: lightblue; cursor: pointer;"
                    onclick="window.open('https://rip-bf5.com.br/api/mini-adm/search/?player-id=${encodeURIComponent(player.player_id)}', '_blank')">
                    ${player.platoon ? `[${player.platoon}] ` : ""}${player.name}
                </td>
                <td style="text-align: center;">${player.latency || 0}ms</td>
                <td id="kills-${player.player_id}" style="text-align: center;">Loading...</td>
                <td id="hs-${player.player_id}" style="text-align: center;">Loading...</td>
                <td id="kd-${player.player_id}" style="text-align: center;">Loading...</td>
                <td id="timePlayed-${player.player_id}" style="text-align: center;">Loading...</td>
                <td id="rank-${player.player_id}" style="text-align: center;">Loading...</td>
                <td style="text-align: center;">
                    <a href="http://rip-bf5.com.br/denuncia/?player=${encodeURIComponent(player.name)}-id=${encodeURIComponent(player.player_id)}" 
                       style="color: red; font-size: 14px;">Denunciar</a>
                </td>
            </tr>
        `;
    }).join('');
    const playerIds = players.map(p => p.player_id);
    verificarBanimentos(playerIds);


    // Adiciona funcionalidade de ordenação após criar a tabela
    addSortingFunctionality(teamDiv);

    // Atualiza os jogadores com estatísticas assim que os dados chegarem
    setTimeout(async () => {
        const playerIds = players.map(p => p.player_id);
        //const playerStatsArray = await fetchAllPlayerStats(playerIds);

        playerStatsArray.forEach(stats => {
            document.getElementById(`kills-${stats.personaId}`).innerText = stats.kills || 0;
            document.getElementById(`hs-${stats.personaId}`).innerText = stats.headshots || 0;
            document.getElementById(`rank-${stats.personaId}`).innerText = stats.rank || 'N/A';
            document.getElementById(`kd-${stats.personaId}`).innerText = stats.killDeath || 0;
            document.getElementById(`timePlayed-${stats.personaId}`).innerText = formatTimePlayed(stats.timePlayed || 0);
        });
    }, 100);
}






function formatTimePlayed(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${hours}h ${minutes}m`;
}

function toggleMapRotation() {
    const mapRotationDiv = document.getElementById('mapRotation');
    mapRotationDiv.style.display = mapRotationDiv.style.display === 'none' ? 'block' : 'none';
}

function togglePlayerMapVisibility() {
    const mapDiv = document.getElementById('playerMapContainer');
    mapDiv.style.display = mapDiv.style.display === 'none' ? 'block' : 'none';
}

function closeDetails() {
    document.getElementById("server-container").innerHTML = "Carregando informações do servidor...";
    fetchServerData("rip");
}

function searchServer() {
    const query = document.getElementById("server-search").value;
    document.getElementById("server-container").innerText = "Carregando informações do servidor...";
    fetchServerData(query);
}

function Core() {
    document.getElementById("server-container").innerText = "Carregando informações do servidor...";
    fetchServerData("core");
}

function DICE() {
    document.getElementById("server-container").innerText = "Carregando informações do servidor...";
    fetchServerData("DICE");
}

function RIP() {
    document.getElementById("server-container").innerText = "Carregando informações do servidor...";
    fetchServerData("RIP");
}

function TDM() {
    document.getElementById("server-container").innerText = "Carregando informações do servidor...";
    fetchServerData("TDM");
}

// Busca inicial padrão
fetchServerData("rip");

            // Seleciona os elementos de áudio
            const sound1 = document.getElementById('sound1');
            const sound2 = document.getElementById('sound2');
            const sounds = [sound1, sound2];

            // Adiciona o evento de clique na página
            document.addEventListener('click', () => {
            // Escolhe um som aleatório
            const randomSound = sounds[Math.floor(Math.random() * sounds.length)];
        
            // Reinicia o áudio e o reproduz
            randomSound.currentTime = 0;
            randomSound.play();
            });

            // Detecta a tecla 'Esc' para fechar a exibição de detalhes
            window.addEventListener("keydown", (event) => {
                if (event.key === "Escape") {
                    closeDetails();
                }
            });

let countdown = 16;

// Atualiza o contador visual a cada segundo
setInterval(() => {
  const countdownElement = document.getElementById("next-update");
  if (countdownElement) {
    countdownElement.innerText = `🔄 Atualizando em ${countdown}s...`;
    countdownElement.style.color = countdown <= 5 ? "orange" : "#00ffcc";
    countdown--;
    if (countdown < 0) countdown = 16;
  }
}, 1000);

// Atualização automática dos jogadores a cada 16 segundos
setInterval(async () => {
  try {
    if (
      typeof renderPlayersFromTeams === "function" &&
      typeof lastServer !== "undefined" &&
      typeof lastServer.gameId !== "undefined"
    ) {
      const gameId = lastServer.gameId;

      const response = await fetch(`https://api.gametools.network/bfv/players/?gameId=${gameId}&_t=${Date.now()}`);
      if (!response.ok) throw new Error("Erro ao atualizar dados de jogadores");

      const data = await response.json();

      if (data?.teams?.length > 0) {
        // Atualiza variáveis globais
        window.lastTeams = data.teams;

        // Limpa as divs para forçar re-renderização
        document.getElementById('div0').innerHTML = '';
        document.getElementById('div1').innerHTML = '';

        // Re-renderiza os jogadores com novos dados
        renderPlayersFromTeams(data.teams, lastServer);
      }
    }
  } catch (err) {
    console.error("⛔ Erro ao atualizar jogadores automaticamente:", err);
  } finally {
    countdown = 16; // Reinicia o contador após a atualização
  }
}, 16000);

        </script>
    </div>
</main>
<!-- /wp:html -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->
<!-- /wp:html -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->
